description: >
    Generate an authentication token and log into ECR.

parameters:
    generator-endpoint:
      description: 'Generate Docker Credentials Endpoint'
        type: string

    environment:
        description: 'ID of the environment'
        type: string

    region:
        description: 'AWS region'
        type: string

steps:
  - run:
      name: Install jq
      command: |
          sudo apt-get update
          sudo apt-get install jq -y

  - run:
      name: 'Generates Docker Credentials'
      command: |
          read endpoint token < <(echo $(curl --request POST \
          "<< parameters.generator-url >>?environment=<< parameters.environment >>&region=<< parameters.region >>" \
          --header "Authorization: token ${HAL_API_TOKEN}" | jq -r '.proxy_endpoint, .authorization_token' ))

          echo "${token}" | docker login \
            --username AWS \
            --password-stdin "${endpoint}"
